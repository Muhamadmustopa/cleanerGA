<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Laporan Task</title>

<style>
body{
  font-family:'Segoe UI',sans-serif;
  background:#f4f6f9;
  margin:0;
  padding:20px;
}

h1{margin-bottom:20px}

.card{
  background:white;
  padding:20px;
  border-radius:12px;
  box-shadow:0 4px 10px rgba(0,0,0,0.05);
  margin-bottom:20px;
}

.filters{
  display:flex;
  gap:15px;
  flex-wrap:wrap;
  align-items:end;
}

label{
  font-size:13px;
  font-weight:600;
}

input, select{
  padding:8px;
  border-radius:6px;
  border:1px solid #ddd;
  width:180px;
}

button{
  padding:10px 15px;
  border:none;
  border-radius:8px;
  background:#007bff;
  color:white;
  cursor:pointer;
  font-weight:600;
}

button:hover{background:#0056b3}

.stats{
  display:flex;
  gap:20px;
  flex-wrap:wrap;
}

.stat-box{
  flex:1;
  min-width:200px;
  background:#007bff;
  color:white;
  padding:20px;
  border-radius:12px;
}

.stat-box h2{
  margin:0;
  font-size:28px;
}

table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
}

th, td{
  padding:10px;
  border-bottom:1px solid #eee;
  text-align:left;
}

th{
  background:#fafafa;
  cursor:pointer;
}

tr:hover{background:#f9f9f9}

.loading{
  text-align:center;
  padding:20px;
}
</style>
</head>

<body>

<h1>ðŸ“Š Dashboard Laporan Task</h1>

<div class="card">
  <div class="filters">
    <div>
      <label>Dari Tanggal</label><br>
      <input type="date" id="fromDate">
    </div>

    <div>
      <label>Sampai Tanggal</label><br>
      <input type="date" id="toDate">
    </div>

    <div>
      <label>Pilih User</label><br>
      <select id="userFilter">
        <option value="">Semua User</option>
      </select>
    </div>

    <button onclick="renderTable(globalData)">ðŸ”Ž Filter</button>
    <button onclick="exportExcel()">Export  Xls</button>
  </div>
</div>

<div class="stats">
  <div class="stat-box">
    <h2 id="totalTask">0</h2>
    <p>Total Task</p>
  </div>
</div>

<div class="card">
  <div class="loading" id="loading">Loading data...</div>
  <table id="dataTable">
    <thead>
      <tr>
        <th onclick="sortTable('tanggal')">Tanggal</th>
        <th onclick="sortTable('nama')">Nama</th>
        <th onclick="sortTable('jam')">Jam</th>
        <th>Task</th>
        <th>Keterangan</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>

const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzQFe0VZcFiOo-gJvx5WF8lCVpvD5EFC3eq6sY4FLIqiWcGT8aziSkGEVZ-VfG0uemE/exec";

let globalData = [];
let filteredData = [];
let sortAsc = true;

function loadData(){
  document.getElementById("loading").style.display="block";

  fetch(WEB_APP_URL + "?action=getReportData")
  .then(res=>res.json())
  .then(data=>{
    globalData = data;
    populateUserFilter(data);
    renderTable(data);
    document.getElementById("loading").style.display="none";
  })
  .catch(err=>{
    console.error(err);
    alert("Gagal load data");
  });
}

function populateUserFilter(data){
  const users = [...new Set(data.map(d=>d.nama))];
  const select = document.getElementById("userFilter");
  select.innerHTML='<option value="">Semua User</option>';
  users.forEach(u=>{
    select.innerHTML += `<option value="${u}">${u}</option>`;
  });
}

function renderTable(data){

  const from = document.getElementById("fromDate").value;
  const to = document.getElementById("toDate").value;
  const user = document.getElementById("userFilter").value;

  filteredData = data.filter(d=>{
    return (!from || d.tanggal >= from)
        && (!to || d.tanggal <= to)
        && (!user || d.nama === user);
  });

  const tbody = document.querySelector("#dataTable tbody");
  tbody.innerHTML="";

  filteredData.forEach(row=>{
    tbody.innerHTML += `
      <tr>
        <td>${row.tanggal}</td>
        <td>${row.nama}</td>
        <td>${row.jam}</td>
        <td>${row.task}</td>
        <td>${row.keterangan || "-"}</td>
      </tr>
    `;
  });

  document.getElementById("totalTask").innerText=filteredData.length;
}

function sortTable(key){
  sortAsc=!sortAsc;
  globalData.sort((a,b)=>{
    return sortAsc
      ? a[key].localeCompare(b[key])
      : b[key].localeCompare(a[key]);
  });
  renderTable(globalData);
}

function exportExcel(){

  if(filteredData.length === 0){
    alert("Tidak ada data untuk di export");
    return;
  }

  let csv = [];
  csv.push(["Tanggal","Nama","Jam","Task","Keterangan"]);

  filteredData.forEach(row=>{
    csv.push([
      row.tanggal,
      row.nama,
      row.jam,
      row.task,
      row.keterangan || ""
    ]);
  });

  let csvContent = csv.map(e => e.join(",")).join("\n");

  const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);

  const from = document.getElementById("fromDate").value || "ALL";
  const to = document.getElementById("toDate").value || "ALL";
  const user = document.getElementById("userFilter").value || "ALL_USER";

  link.download = `Laporan_${user}_${from}_sampai_${to}.csv`;
  link.click();
}

loadData();

</script>

</body>
</html>
