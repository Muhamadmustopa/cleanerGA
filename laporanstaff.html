<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Laporan Task</title>

<style>
body{
  font-family:'Segoe UI',sans-serif;
  background:#f4f6f9;
  margin:0;
  padding:20px;
}

h1{margin-bottom:20px}

.card{
  background:white;
  padding:20px;
  border-radius:12px;
  box-shadow:0 4px 10px rgba(0,0,0,0.05);
  margin-bottom:20px;
}

.filters{
  display:flex;
  gap:15px;
  flex-wrap:wrap;
  align-items:end;
}

label{
  font-size:13px;
  font-weight:600;
}

input, select{
  padding:8px;
  border-radius:6px;
  border:1px solid #ddd;
  width:180px;
}

/* ===== EXCEL ICON BUTTON ===== */

.excel-btn{
  width:45px;
  height:45px;
  border-radius:8px;
  background:#1D6F42;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  transition:0.3s;
  position:relative;
}

.excel-btn:hover{
  background:#145A32;
  transform:scale(1.05);
}

.excel-btn::after{
  content:"Export Excel";
  position:absolute;
  bottom:-30px;
  background:black;
  color:white;
  font-size:12px;
  padding:5px 8px;
  border-radius:6px;
  opacity:0;
  transition:0.3s;
  white-space:nowrap;
}

.excel-btn:hover::after{
  opacity:1;
}

/* ===== STATS ===== */

.stats{
  display:flex;
  gap:20px;
  flex-wrap:wrap;
}

.stat-box{
  flex:1;
  min-width:200px;
  background:#007bff;
  color:white;
  padding:20px;
  border-radius:12px;
}

.stat-box h2{
  margin:0;
  font-size:28px;
}

/* ===== TABLE ===== */

.table-container{
  max-height:520px; /* kira2 11 row */
  overflow-y:auto;
  border:1px solid #ccc;
  border-radius:8px;
}

table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
}

th, td{
  border:1px solid #ccc;
  padding:10px;
  text-align:left;
}

/* HEADER KUNING */

th{
  background:#FFD700;
  color:black;
  font-weight:700;
  position:sticky;
  top:0;
  z-index:2;
  cursor:pointer;
}

/* ZEBRA ROW */

tbody tr:nth-child(odd){
  background:white;
}

tbody tr:nth-child(even){
  background:#f2f2f2;
}

tbody tr:hover{
  background:#d9edf7;
  transition:0.2s;
}

.loading{
  text-align:center;
  padding:20px;
}
</style>
</head>

<body>

<h1>ðŸ“Š Dashboard Laporan Task</h1>

<div class="card">
  <div class="filters">

    <div>
      <label>Dari Tanggal</label><br>
      <input type="date" id="fromDate">
    </div>

    <div>
      <label>Sampai Tanggal</label><br>
      <input type="date" id="toDate">
    </div>

    <div>
      <label>Pilih User</label><br>
      <select id="userFilter">
        <option value="">Semua User</option>
      </select>
    </div>

    <div onclick="renderTable(globalData)" 
         style="padding:10px 15px;background:#007bff;color:white;border-radius:8px;cursor:pointer;">
         ðŸ”Ž Filter
    </div>

    <!-- Excel Icon -->
    <div class="excel-btn" onclick="exportExcel()">
      <svg width="22" height="22" fill="white" viewBox="0 0 24 24">
        <path d="M19 2H8c-1.1 0-2 .9-2 2v3H3v10h3v3c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM8 4h11v16H8V4zm-3 5h3v6H5V9zm7.2 7l-1.7-2.6L8.8 16H7l2.3-3.5L7 9h1.8l1.6 2.5L12 9h1.8l-2.3 3.5L14 16h-1.8z"/>
      </svg>
    </div>

  </div>
</div>

<div class="stats">
  <div class="stat-box">
    <h2 id="totalTask">0</h2>
    <p>Total Task</p>
  </div>
</div>

<div class="card">
  <div class="loading" id="loading">Loading data...</div>

  <div class="table-container">
    <table id="dataTable">
      <thead>
        <tr>
          <th onclick="sortTable('tanggal')">Tanggal</th>
          <th onclick="sortTable('nama')">Nama</th>
          <th onclick="sortTable('jam')">Jam</th>
          <th>Task</th>
          <th>Keterangan</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>

const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzQFe0VZcFiOo-gJvx5WF8lCVpvD5EFC3eq6sY4FLIqiWcGT8aziSkGEVZ-VfG0uemE/exec";

let globalData = [];
let filteredData = [];
let sortAsc = true;

function loadData(){
  document.getElementById("loading").style.display="block";

  fetch(WEB_APP_URL + "?action=getReportData")
  .then(res=>res.json())
  .then(data=>{
    globalData = data;
    populateUserFilter(data);
    renderTable(data);
    document.getElementById("loading").style.display="none";
  });
}

function populateUserFilter(data){
  const users = [...new Set(data.map(d=>d.nama))];
  const select = document.getElementById("userFilter");
  select.innerHTML='<option value="">Semua User</option>';
  users.forEach(u=>{
    select.innerHTML += `<option value="${u}">${u}</option>`;
  });
}

function renderTable(data){

  const from = document.getElementById("fromDate").value;
  const to = document.getElementById("toDate").value;
  const user = document.getElementById("userFilter").value;

  filteredData = data.filter(d=>{
    return (!from || d.tanggal >= from)
        && (!to || d.tanggal <= to)
        && (!user || d.nama === user);
  });

  const tbody = document.querySelector("#dataTable tbody");
  tbody.innerHTML="";

  filteredData.forEach(row=>{
    tbody.innerHTML += `
      <tr>
        <td>${row.tanggal}</td>
        <td>${row.nama}</td>
        <td>${row.jam}</td>
        <td>${row.task}</td>
        <td>${row.keterangan || "-"}</td>
      </tr>
    `;
  });

  document.getElementById("totalTask").innerText=filteredData.length;
}

function sortTable(key){
  sortAsc=!sortAsc;
  globalData.sort((a,b)=>{
    return sortAsc
      ? a[key].localeCompare(b[key])
      : b[key].localeCompare(a[key]);
  });
  renderTable(globalData);
}

function exportExcel(){

  if(filteredData.length === 0){
    alert("Tidak ada data untuk di export");
    return;
  }

  let csv = [];
  csv.push(["Tanggal","Nama","Jam","Task","Keterangan"]);

  filteredData.forEach(row=>{
    csv.push([
      row.tanggal,
      row.nama,
      row.jam,
      row.task,
      row.keterangan || ""
    ]);
  });

  let csvContent = csv.map(e => e.join(",")).join("\n");

  const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);

  const from = document.getElementById("fromDate").value || "ALL";
  const to = document.getElementById("toDate").value || "ALL";
  const user = document.getElementById("userFilter").value || "ALL_USER";

  link.download = `Laporan_${user}_${from}_sampai_${to}.csv`;
  link.click();
}

loadData();

</script>

</body>
</html>
