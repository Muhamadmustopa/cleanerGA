<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Checklist Driver Daily</title>

<style>
:root{
  --primary:#1976d2;
  --success:#4CAF50;
  --danger:#f44336;
  --border:#e0e0e0;
}

*{box-sizing:border-box}

body{
  margin:0;
  padding:14px;
  font-family:Segoe UI,Arial;
  background:linear-gradient(180deg,#e3f2fd,#f4f6f8);
}

.card{
  max-width:900px;
  margin:auto;
  background:#fff;
  border-radius:18px;
  padding:16px;
  box-shadow:0 8px 20px rgba(0,0,0,.12);
}

.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.logout{
  background:var(--danger);
  color:#fff;
  border:none;
  padding:10px 14px;
  border-radius:12px;
}

label{font-size:14px;font-weight:600}

input,select,textarea{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:1px solid #ccc;
  margin-top:6px;
}

.section{
  border:1px solid var(--border);
  border-radius:16px;
  padding:14px;
  margin-top:14px;
}

.section h4{
  margin:0 0 12px;
  color:var(--primary)
}

/* ===== GRID RESPONSIVE ===== */
.grid{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:10px;
}

@media(max-width:480px){
  .grid{
    grid-template-columns:1fr;
  }
}

/* ITEM */
.item{
  display:flex;
  align-items:flex-start;
  gap:10px;
  padding:12px;
  border:1px solid var(--border);
  border-radius:12px;
  cursor:pointer;
}

.item span{
  line-height:1.3;
}

.item input{
  margin-top:3px;
  accent-color:var(--primary);
}

.item.active{
  background:#e3f2fd;
  border-color:var(--primary);
}

.trip{
  display:grid;
  gap:8px;
  margin-bottom:8px;
}

.add{
  width:100%;
  padding:12px;
  background:#e3f2fd;
  border:1px dashed var(--primary);
  border-radius:12px;
}

.save{
  width:100%;
  margin-top:18px;
  padding:14px;
  border:none;
  border-radius:16px;
  background:var(--success);
  color:#fff;
  font-size:16px;
}

.hidden{display:none}
</style>
</head>

<body>

<div class="card">

  <div class="header">
    <div>
      <strong>Checklist Driver Daily</strong><br>
      <small>Pencatatan Tugas Harian</small>
    </div>
    <button class="logout" onclick="logout()">Keluar</button>
  </div>

  <label>Nama Driver</label>
  <select id="driver">
    <option value="">-- Pilih Driver --</option>
    <option>Ahmad Yani</option>
    <option>Sandi Suhendra</option>
  </select>

  <br><br>

  <label>Tanggal</label>
  <input type="date" id="tanggal">

  <div id="taskArea" class="hidden">

    <!-- PERJALANAN -->
    <div class="section">
      <h4>üöó Pengantaran</h4>
      <div id="tripList"></div>
      <button class="add" onclick="addTrip()">+ Tambah Tujuan</button>
    </div>

    <!-- KENDARAAN -->
    <div class="section">
      <h4>üîß Perawatan Kendaraan</h4>
      <div class="grid">
        <label class="item"><input type="checkbox" data-kendaraan="Cuci Mobil"><span>Cuci Mobil</span></label>
        <label class="item"><input type="checkbox" data-kendaraan="Panaskan Mesin"><span>Panaskan Mesin</span></label>
        <label class="item"><input type="checkbox" data-kendaraan="Checklist Mobil"><span>Checklist Pengecekan Mobil</span></label>
        <label class="item"><input type="checkbox" data-kendaraan="Lampu & Ban"><span>Lampu & Semua Ban</span></label>
        <label class="item"><input type="checkbox" data-kendaraan="BBM & KM"><span>BBM & Kilometer</span></label>
      </div>
      <textarea id="noteKendaraan" placeholder="Catatan kendaraan"></textarea>
    </div>

    <!-- TUGAS LAIN -->
    <div class="section">
      <h4>üì¶ Tugas Lainnya</h4>
      <div class="grid">
        <label class="item"><input type="checkbox" data-tugas="Angkut Barang"><span>Angkut Barang</span></label>
        <label class="item"><input type="checkbox" data-tugas="Frontliner"><span>Standby Frontliner</span></label>
        <label class="item"><input type="checkbox" data-tugas="Lainnya"><span>Tugas Lain</span></label>
      </div>
      <textarea id="noteTugas" placeholder="Catatan tugas lain"></textarea>
    </div>

    <button class="save" onclick="simpan()">Simpan</button>
  </div>
</div>

<script>
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzgajiNxIg_NbBBWyMv9Cxa7kew_RSgcRV3cmg4PgWdXgXZpu2Os9Eyfq4pM-Us8_Bp/exec';

const elDriver = document.getElementById('driver');
const elTanggal = document.getElementById('tanggal');
const taskArea  = document.getElementById('taskArea');
const tripList  = document.getElementById('tripList');
const noteKend  = document.getElementById('noteKendaraan');
const noteTugas = document.getElementById('noteTugas');

elTanggal.valueAsDate = new Date();

/* SESSION DRIVER */
const savedDriver = localStorage.getItem('driver_name');
if(savedDriver){
  elDriver.value = savedDriver;
  taskArea.classList.remove('hidden');
}

elDriver.addEventListener('change',()=>{
  if(elDriver.value){
    localStorage.setItem('driver_name',elDriver.value);
    taskArea.classList.remove('hidden');
  }else{
    taskArea.classList.add('hidden');
  }
});

/* CHECKBOX UI */
document.addEventListener('change',e=>{
  if(e.target.matches('.item input')){
    e.target.parentElement.classList.toggle('active',e.target.checked);
  }
});

/* ADD TRIP */
function addTrip(){
  const d=document.createElement('div');
  d.className='trip';
  d.innerHTML = `
    <input placeholder="Tujuan">
    <input placeholder="Jam">
  `;
  tripList.appendChild(d);
}

/* CEK DUPLIKAT */
async function cekDuplikat(){
  const url = `${SCRIPT_URL}?action=check&driver=${encodeURIComponent(elDriver.value)}&tanggal=${elTanggal.value}`;
  const r = await fetch(url);
  const j = await r.json();
  return j.exists === true;
}

/* SIMPAN */
async function simpan(){
  if(await cekDuplikat()){
    alert('‚ùå Data sudah ada');
    return;
  }

  const payload=[];

  document.querySelectorAll('#tripList .trip').forEach(r=>{
    if(r.children[0].value){
      payload.push({
        driver:elDriver.value,
        tanggal:elTanggal.value,
        kategori:'PERJALANAN',
        detail:`${r.children[0].value} ${r.children[1].value}`,
        status:'SELESAI',
        catatan:''
      });
    }
  });

  document.querySelectorAll('[data-kendaraan]').forEach(c=>{
    payload.push({
      driver:elDriver.value,
      tanggal:elTanggal.value,
      kategori:'KENDARAAN',
      detail:c.dataset.kendaraan,
      status:c.checked?'OK':'TIDAK',
      catatan:noteKend.value
    });
  });

  document.querySelectorAll('[data-tugas]:checked').forEach(c=>{
    payload.push({
      driver:elDriver.value,
      tanggal:elTanggal.value,
      kategori:'TUGAS_LAIN',
      detail:c.dataset.tugas,
      status:'SELESAI',
      catatan:noteTugas.value
    });
  });

  const res = await fetch(SCRIPT_URL,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(payload)
  }).then(r=>r.json());

  if(res.status==='SUCCESS'){
    alert('‚úÖ Data tersimpan');
    location.reload();
  }else{
    alert('‚ùå Gagal menyimpan');
  }
}

function logout(){
  localStorage.removeItem('driver_name');
  location.replace('login.html');
}
</script>

</body>
</html>
