<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Laporan Cleaner</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  margin:0;
  font-family:Segoe UI,Arial;
  background:linear-gradient(180deg,#e3f2fd,#f4f6f8);
  padding:16px;
}
.card{
  max-width:1100px;
  margin:auto;
  background:#fff;
  border-radius:18px;
  padding:18px;
  box-shadow:0 8px 20px rgba(0,0,0,.12);
}
h2{margin:0 0 16px}

/* DASHBOARD */
.dashboard{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:16px;
  margin-bottom:20px;
}
.chart-box{
  padding:10px;
  border:1px solid #eee;
  border-radius:14px;
}

/* FILTER */
.filters{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:10px;
  margin-bottom:12px;
}
select,input{
  padding:10px;
  border-radius:12px;
  border:1px solid #ccc;
}

/* TABLE */
table{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}
th,td{
  border:1px solid #ddd;
  padding:8px;
}
th{background:#f0f0f0}

.group{
  background:#e3f2fd;
  font-weight:600;
}
</style>
</head>

<body>
<div class="card">

<h2>ðŸ“Š Laporan Checklist Cleaner</h2>

<!-- DASHBOARD -->
<div class="dashboard">
  <div class="chart-box"><canvas id="chartStatus"></canvas></div>
  <div class="chart-box"><canvas id="chartLokasi"></canvas></div>
  <div class="chart-box"><canvas id="chartCleaner"></canvas></div>
</div>

<!-- FILTER -->
<div class="filters">
  <select id="filterBulan">
    <option value="">Semua Bulan</option>
  </select>

  <select id="filterNama">
    <option value="">Semua Cleaner</option>
  </select>

  <select id="filterLokasi">
    <option value="">Semua Lokasi</option>
    <option value="MTH">MTH</option>
    <option value="BIZ">BIZ</option>
  </select>

  <input type="text" id="search" placeholder="Cari task / area">
</div>

<table>
<thead>
<tr>
  <th>Tanggal</th>
  <th>Cleaner</th>
  <th>Lokasi</th>
  <th>Area</th>
  <th>Task</th>
  <th>Status</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

</div>

<script>
google.script.run.withSuccessHandler(init).getReportData();

let rawData=[];

function init(data){
  rawData=data;
  buildFilter();
  buildChart();
  renderTable();
}

function buildFilter(){
  const bulan=new Set();
  const nama=new Set();

  rawData.forEach(r=>{
    bulan.add(r[0].toString().substring(0,7));
    nama.add(r[1]);
  });

  bulan.forEach(b=>{
    filterBulan.innerHTML+=`<option>${b}</option>`;
  });
  nama.forEach(n=>{
    filterNama.innerHTML+=`<option>${n}</option>`;
  });
}

function renderTable(){
  tbody.innerHTML='';
  let lastMonth='';

  rawData
    .filter(r=>{
      if(filterBulan.value && !r[0].startsWith(filterBulan.value)) return false;
      if(filterNama.value && r[1]!==filterNama.value) return false;
      if(filterLokasi.value && r[2]!==filterLokasi.value) return false;
      if(search.value && !(r[3]+r[4]).toLowerCase().includes(search.value.toLowerCase())) return false;
      return true;
    })
    .forEach(r=>{
      const month=r[0].substring(0,7);
      if(month!==lastMonth){
        tbody.innerHTML+=`<tr class="group"><td colspan="6">${month}</td></tr>`;
        lastMonth=month;
      }
      tbody.innerHTML+=`
        <tr>
          <td>${r[0]}</td>
          <td>${r[1]}</td>
          <td>${r[2]}</td>
          <td>${r[3]}</td>
          <td>${r[4]}</td>
          <td>${r[5]}</td>
        </tr>`;
    });
}

function buildChart(){
  const count=(idx)=>{
    const m={};
    rawData.forEach(r=>m[r[idx]]=(m[r[idx]]||0)+1);
    return m;
  };

  new Chart(chartStatus,{
    type:'pie',
    data:{labels:Object.keys(count(5)),datasets:[{data:Object.values(count(5))}]}
  });

  new Chart(chartLokasi,{
    type:'pie',
    data:{labels:Object.keys(count(2)),datasets:[{data:Object.values(count(2))}]}
  });

  new Chart(chartCleaner,{
    type:'pie',
    data:{labels:Object.keys(count(1)),datasets:[{data:Object.values(count(1))}]}
  });
}

filterBulan.onchange=renderTable;
filterNama.onchange=renderTable;
filterLokasi.onchange=renderTable;
search.onkeyup=renderTable;
</script>

</body>
</html>
